**Кратко**
- В `src/adsorb_synthesis/data_processing.py:add_thermodynamic_features` термодинамика реализована неверно: запасной расчёт `K_eq = exp(E/(R·T))` и `Delta_G = -E` не имеют физического смысла, поэтому производные столбцы (`K_equilibrium`, `Delta_G_equilibrium`, `Delta_G_residual`) недостоверны.
- Несоответствие инженерии признаков train↔BO: `Supersaturation_Index` в обучении = `Molarity_Metal * Molarity_Ligand`, в `scripts/run_bayes_opt.py` используется другая формула с гидратацией, что ведёт к дрейфу признаков на инференсе.
- Физические проверки слабые: дефолтный режим валидации “warn”, `scripts/validate_physics_constraints.py` вызывает отсутствующий `adsorb_synthesis.physics_losses`, в BO нет проверки точек кипения растворителей и целевых стехиометрий, допускаются физически невозможные рецепты.
- UQ и BO слабо связаны: ансамбль — пять CatBoost на одном разбиении с разными сидами, дисперсия отражает только стохастику; в BO неопределённость не используется.

**Схема потока**
Данные CSV → `load_dataset` (молярные массы, термофичи, адсорбционные фичи, категории, соль/физхимия, валидация) → `build_lookup_tables` → `prepare_forward_dataset` (логи, дескрипторы, engineered features) → `scripts/train_forward_model.py` (стратификация, отбор признаков, 5×CatBoost/таргет → `artifacts/forward_models`) → `scripts/run_bayes_opt.py` (Optuna TPE, ручное построение признаков, ансамблевые предсказания) → `predictions_bo.csv`.

**Химия и физика**
- Стехиометрия: `R_molar` = n_salt/n_acid; число координационных узлов лиганда (`carboxyl_groups`) и `STOICHIOMETRY_TARGETS` из `constants.py` не используются — химически обязательные соотношения (например, Zr–BDC 1:1) не контролируются. В `add_physicochemical_descriptors` неизвестные коэффициенты гидратации заменяются на 0, смешивая “неизвестно” с “безводно”.
- Supersaturation: уже в обучении размерность неверна (mol²/L² вместо безразмерной величины), а в BO формула другая (с гидратацией и иной нормировкой), что создаёт дрейф распределения признака.
- Электронные дескрипторы: `d_electrons`, `Jahn_Teller_Active` предполагаются в CSV, но не вычисляются и не валидируются; степени окисления не проверяются.
- Термодинамика: использование Dubinin-энергии `E` как Gibbs приводит к бессмысленным `K_equilibrium` и `Delta_G`; корректно оставлять NaN или вычислять $\Delta G = -RT \ln K$ только при наличии измеренного $K$.
- Валидация: режим по умолчанию “warn”; строки с $W_s < W_0$ или $T_{syn}$ выше точки кипения растворителя могут попасть в обучение.

**ML и BO**
- UQ: ансамбль на одном train/test-разбиении — плохой охват эпистемической неопределённости; нет бутстрапа/оут-оф-фолд, нет калибровки σ.
- Отбор признаков: VIF/корреляции могут удалить парные доменно-важные фичи (например, `Molarity_Metal` и `Molarity_Ligand`); категориальные фичи не участвуют в проверке мультиколлинеарности.
- Целевая функция BO: сумма нормированных квадратов; веса не масштабированы под величины таргетов, σ предсказаний игнорируется; не используются EI/PI или penalisation by σ.
- Ограничения в BO: только порядок температур и широкий диапазон 0.1 < n_salt/n_acid < 10; нет проверки точки кипения (константы есть в `SOLVENT_BOILING_POINTS_C`), нет применения `STOICHIOMETRY_TARGETS`.

**Баги / несоответствия**
- `scripts/validate_physics_constraints.py` не работает — `adsorb_synthesis.physics_losses` отсутствует.
- `add_thermodynamic_features` использует неверные формулы для $K_{eq}$ и $\Delta G$ → мусорные колонки.
- Drift признаков: `Supersaturation_Index` вычисляется по-разному в обучении и в BO.
- Заполнение гидратации нулями скрывает отсутствие данных.
- BO не проверяет температуру относительно точки кипения растворителя.

**Рекомендации**
- Исправить термодинамику: не выводить $K_{eq}$ из $E$; считать $\Delta G=-RT\ln K$ только при наличии $K$, иначе оставлять NaN.
- Синхронизировать инженерные признаки (Supersaturation, гидратация) между обучением и `run_bayes_opt.py`, либо переобучить модели с новой формулой.
- Довести SALT_MASS_FIX: обучать на `log_salt_mass` с MAE/квантильной целью, на инференсе применять `expm1`.
- Усилить UQ: бутстрап/оут-оф-фолд ансамбли, калибровка σ, включение σ в BO (минимизация μ+λσ или EI/PI).
- Жёстче физические фильтры: проверка точки кипения, применение `STOICHIOMETRY_TARGETS`, фильтр $W_s \ge W_0$, реалистичные границы для $E_0$ и $E/E_0$.
- Добавить/восстановить `physics_losses.py` или убрать неработающие вызовы; включить физические штрафы/проверки в тренировочный и BO контуры.



Усилить UQ: бутстрап/оут-оф-фолд ансамбли, калибровка σ, включение σ в BO (минимизация μ+λσ или EI/PI).
    Готово: модели переобучены с бутстрап-ансамблем и калибровкой σ, BO отработал с риск-аверсной целью.

    Что произошло

    - Валидация при загрузке данных выдала предупреждения о порядке температур и превышении точки кипения (строки с этанолом/
        ацетонитрилом/водой). Режим warn, обучение продолжилось.
    - Бутстрап (5 членов) + OOB-калибровка σ сохранены в artifacts/forward_models/uncertainty_calibrators.joblib. Метаданные калибраторов
        добавлены в artifacts/forward_models/metrics.json.
    - Метрики (test R²): W0≈0.28, E0≈0.89, SБЭТ≈0.37, x0≈0.89, Sme≈0.58 (небольшое проседание W0/SБЭТ/Sme из‑за бутстрапа, в пределах
        ожиданий).
    - BO с λ=0.5 на σ нашёл топ-рецепты (предсказания ~W0 0.42–0.43, E0 ~30, SБЭТ ~1,000–1,050, x0 ~0.44, Sme ~74–78) при минимуме
        loss≈0.068; лучшая связка Zn + NH2-BDC, Tсин≈115 °C.

    Где смотреть

    - Калибраторы и новые модели: artifacts/forward_models/*.
    - Обновлённые метрики: artifacts/forward_models/metrics.json.
    - BO результаты: predictions_bo.csv, лог — в консоли.

    Если нужно: можем подобрать другой λ (через флаг/константу) или усилить фильтрацию входных данных (строгие проверки порядка
    температур/точек кипения), чтобы избежать предупреждений.



  Не сделано

  - Валидация по умолчанию остаётся “warn” (src/adsorb_synthesis/data_validation.py:8-13), load_dataset всегда вызывает её в warn-
    режиме (src/adsorb_synthesis/data_processing.py:149-186), поэтому строки с неверным порядком температур или T_syn выше точки
    кипения не блокируются при обучении.
  - Цель BO осталась простой относительной MSE + λσ (scripts/run_bayes_opt.py:257-332): нет EI/PI, нет автоматических весов по
    дисперсии/масштабу таргетов.
  - Рекомендация SALT_MASS_FIX не реализована: лог-трансформация/expm1 для масс соли отсутствуют.
  - Физические штрафы из src/adsorb_synthesis/physics_losses.py не используются ни в обучении, ни в BO; только сломанный скрипт
    валидации их вызывает.
  - Электронные/окислительные дескрипторы (d_electrons, Jahn_Teller_Active, oxidation_state и др.) нигде не вычисляются и не
    проверяются — код предполагает их наличие в CSV, иначе build_lookup_tables упадёт.
