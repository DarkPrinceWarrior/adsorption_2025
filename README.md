# Adsorbent Inverse Design Framework (2025)

## Аннотация
Данный репозиторий реализует систему **обратного дизайна (Inverse Design)** пористых металл-органических каркасов (MOF). Система решает фундаментальную проблему материаловедения: поиск оптимальных условий синтеза для получения материала с заранее заданными структурно-энергетическими характеристиками (СЭХ).

В основе подхода лежит гибридная архитектура:
1.  **Deep Ensemble Forward Model:** Ансамбль градиентных бустингов (CatBoost) для предсказания свойств материала по условиям синтеза с оценкой эпистемической неопределенности (Uncertainty Quantification).
2.  **Bayesian Optimization (Navigator):** Использование алгоритма Tree-structured Parzen Estimator (TPE) для навигации в пространстве химических реакций и поиска рецепта, удовлетворяющего критериям пользователя.

---

## 1. Методология

### Прямая задача (Forward Problem)
Мы моделируем функцию $f: \text{Synthesis} \to \text{Properties}$.
*   **Входные данные ($X$):** 
    *   *Химические реагенты:* Тип металла (ионный радиус, электроотрицательность, атомная масса), тип лиганды (молекулярная масса), растворитель.
    *   *Параметры процесса:* Температуры синтеза, сушки и активации ($T_{syn}, T_{dry}, T_{act}$), время, стехиометрические соотношения (Metal/Ligand ratio), концентрации.
*   **Целевые переменные ($Y$):**
    *   $W_0$ [см³/г] — Предельный объем микропор (по теории ТЭОМ / Дубинина-Радушкевича).
    *   $E_0$ [кДж/моль] — Характеристическая энергия адсорбции.
    *   $S_{BET}$ [м²/г] — Удельная поверхность по БЭТ.
    *   $S_{me}$ [м²/г] — Удельная поверхность мезопор (важно для транспортных свойств).
    *   $x_0$ [нм] — Характеристическая полуширина пор.

### Оценка неопределенности (Uncertainty Quantification)
Вместо точечного прогноза, система выдает распределение $P(y|x)$. Мы используем ансамбль из 5 моделей, обученных с различной инициализацией и стратификацией данных.
*   **Среднее значение ($\mu$):** Наиболее вероятное свойство.
*   **Стандартное отклонение ($\sigma$):** Мера уверенности модели. Если рецепт находится в "неизведанной" области химического пространства, $\sigma$ возрастает, что позволяет отфильтровывать ненадежные прогнозы.

---

## 2. Установка и Настройка

Требуется Python 3.10+.

```bash
# 1. Создание виртуального окружения
python3 -m venv venv
source venv/bin/activate

# 2. Установка зависимостей (CatBoost, Optuna, Pandas, Scikit-Learn)
pip install -r requirements.txt
```

---

## 3. Руководство пользователя (Workflow)

### Этап I: Обучение модели (Training)
Система обучается на экспериментальных данных, автоматически генерируя физико-химические дескрипторы.
Используется **Target-based Stratification** для корректной работы с редкими материалами (например, с аномально высокой мезопористостью).

```bash
PYTHONPATH=src python scripts/train_forward_model.py \
    --data data/SEC_SYN_with_features_DMFA_only.csv \
    --iterations 500
```
*Результат:* В папке `artifacts/forward_models` создаются 5 ансамблей (по одному на каждое целевое свойство).

### Этап II: Валидация (Validation)
Перед использованием рекомендуется проверить надежность моделей. Скрипт строит **Rejection Plots**, показывая, как падает ошибка (MAE) при отсеве неуверенных прогнозов.

```bash
PYTHONPATH=src python scripts/validate_uncertainty.py
```
*Результат:* Графики в `artifacts/plots/uncertainty_rejection_plots.png`.
*Метрики (на тестовой выборке):*
*   **$x_0$:** $R^2 \approx 0.87$
*   **$S_{me}$:** $R^2 \approx 0.83$ (высокая точность предсказания мезопор)
*   **$E_0$:** $R^2 \approx 0.85$

### Этап III: Поиск рецепта (Inverse Design)
Основной инструмент исследователя. Вы задаете желаемые СЭХ, а алгоритм ищет оптимальные условия синтеза.

**Пример запроса:** Найти материал с развитой микропористостью ($W_0 \approx 0.48$), высокой энергией адсорбции ($E_0 \approx 29.3$) и удельной поверхностью БЭТ $\approx 1100$.

```bash
PYTHONPATH=src python scripts/run_bayes_opt.py \
    --W0 0.48 \
    --E0 29.3 \
    --x0 0.41 \
    --SBET 1100 \
    --Sme 82 \
    --trials 300
```

**Аргументы:**
*   `--W0`, `--E0`, `--SBET`, `--x0`, `--Sme`: Целевые значения свойств.
*   `--trials`: Количество итераций поиска (рекомендуется 200-500).

*Результат:* Файл `predictions_bo.csv` с ранжированным списком рецептов.
В файле указаны не только условия синтеза (Металл, Лиганд, $T_{syn}$), но и предсказанная **неопределенность** ($\sigma$). Выбирайте рецепты с низким значением `Pred_Uncertainty`.

---

## 4. Структура проекта

```
├── scripts/
│   ├── train_forward_model.py  # Обучение Deep Ensembles
│   ├── validate_uncertainty.py # Оценка качества и калибровка
│   └── run_bayes_opt.py        # Inverse Design (Поиск рецептов)
├── src/
│   └── adsorb_synthesis/
│       ├── data_processing.py  # Генерация дескрипторов и очистка
│       ├── constants.py        # Справочники (Molar Masses, Features)
│       └── ...
├── data/                       # Экспериментальные датасеты
└── artifacts/                  # Сохраненные модели и графики
```

## 5. Особенности реализации
*   **Feature Selection:** Для каждого целевого свойства автоматически отбирается свой уникальный набор из топ-15 наиболее значимых признаков, что предотвращает переобучение.
*   **Physicochemical Constraints:** Оптимизатор учитывает жесткие ограничения (например, $T_{dry}$ не может быть сильно выше $T_{syn}$, стехиометрические соотношения должны быть в разумных пределах).
*   **Robustness:** Использование `CatBoost` позволяет эффективно работать с категориальными данными (тип растворителя, природа соли) без потери информации при One-Hot кодировании.
